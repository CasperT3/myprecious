{{ if or .Values.plex.enabled .Values.plexranger.enabled .Values.plexhobbit.enabled .Values.plexhalfling.enabled .Values.plexnazgul.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: plex-env
data:
  # PLEX_PREFERENCE_1: "FriendlyName=ElfHosted | {{ .Release.Name }}"
  PLEX_PREFERENCE_2: "FSEventLibraryPartialScanEnabled=1"
  PLEX_PREFERENCE_3: "FSEventLibraryUpdatesEnabled=1"
  PLEX_PREFERENCE_4: "TranscoderPhotoFileSizeLimitMiB=5"
  # PLEX_PREFERENCE_5: "ScannerLowPriority=1"
  # PLEX_PREFERENCE_6: "TranscodeCountLimit=3"
  PLEX_PREFERENCE_7: "autoEmptyTrash=0"
  PLEX_PREFERENCE_8: "BackgroundTranscodeLowPriority=1"
  PLEX_PREFERENCE_9: "LongRunningJobThreads=1"
  PLEX_PREFERENCE_11: "RelayEnabled=0"
  PLEX_PREFERENCE_12: "TranscoderTempDirectory=/transcode"
  PLEX_PREFERENCE_13: "MinutesAllowedPaused=30"
  PLEX_PREFERENCE_14: "GenerateIntroMarkerBehavior=scheduled"
  PLEX_PREFERENCE_16: "ButlerEndHour=10"
  PLEX_PREFERENCE_17: "ButlerTaskDeepMediaAnalysis=0" # this wrecks remote mounts
  PLEX_PREFERENCE_18: "ButlerTaskUpgradeMediaAnalysis=0" # suspect this does too

  {{ if not .Values.plexnazgul.enabled }}
  PLEX_PREFERENCE_15: "ButlerStartHour=9"
  PLEX_PREFERENCE_10: "TranscoderH264BackgroundPreset=ultrafast"
  PLEX_PREFERENCE_19: "MarkerSource=cloud" # get credit markers from online DBs only
  PLEX_PREFERENCE_20: "GenerateCreditsMarkerBehavior=never" # don't scan for credits
  PLEX_PREFERENCE_21: "GenerateChapterThumbBehavior=never" # don't generate thumbnails
  PLEX_PREFERENCE_22: "GenerateChapterThumbBehavior=never" # don't generate thumbnails
  PLEX_PREFERENCE_23: "GenerateIntroMarkerBehavior=never" # don't detect intros for skippage
  PLEX_PREFERENCE_24: "GenerateBIFBehavior=never" # don't generate video preview thumbnails
  {{ else }}
  PLEX_PREFERENCE_15: "ButlerStartHour=7"
  {{ end }}
  
    
  # For custom domains
  {{- if .Values.plexcustomdomain.enabled }}
  ADVERTISE_IP: "https://{{ .Values.plexcustomdomain.cname | lower }}:443"
  {{ else }}
  ADVERTISE_IP: "https://{{ .Release.Name }}-plex.{{ .Values.dns_domain }}:443"
  {{ end }}

  # For plex-requests
  {{ if .Values.overseerr.enabled }}
  OVERSEERR_HOST: http://overseerr:5055
  TMPDIR: /tmp
  # unnecessary but the apps won't start without it
  BLACKHOLE_RD_MOUNT_REFRESH_SECONDS: "30"
  BLACKHOLE_WAIT_FOR_TORRENT_TIMEOUT: "30"
  BLACKHOLE_FAIL_IF_NOT_CACHED: "true"
  BLACKHOLE_HISTORY_PAGE_SIZE: "500"
  PLEX_SERVER_MOVIE_LIBRARY_ID: "1"
  PLEX_SERVER_TV_SHOW_LIBRARY_ID: "2"

  PLEX_HOST: "https://plex.tv/"
  PLEX_METADATA_HOST: "https://metadata.provider.plex.tv/"
  PLEX_SERVER_HOST: http://localhost
  PLEX_SERVER_PATH: /plex/
  {{ end }}
  
  # to ensure VPN is up first
  WAIT_FOR_VPN: "true"
{{ end }}